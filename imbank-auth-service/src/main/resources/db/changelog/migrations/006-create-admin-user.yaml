databaseChangeLog:
  - changeSet:
      id: 006-create-admin-user
      author: jack
      preConditions:
        - onFail: MARK_RAN
        - not:
            - sqlCheck:
                expectedResult: "1"
                sql: "SELECT COUNT(*) FROM users WHERE username = 'admin'"
      changes:
        # Insert first admin user
        - insert:
            tableName: users
            columns:
              - column:
                  name: username
                  value: "admin"
              - column:
                  name: email
                  value: "admin@imbank.com"
              - column:
                  name: password
                  # BCrypt hash of "Admin@123"
                  value: "$2a$10$Y/Tm37Rr/Els3elYryl7Hezg60bFVAbqvkRbBeqvWjfBKyivSOA5i"
              - column:
                  name: enabled
                  valueBoolean: true
              - column:
                  name: account_non_locked
                  valueBoolean: true
              - column:
                  name: created_at
                  valueComputed: "CURRENT_TIMESTAMP"
              - column:
                  name: updated_at
                  valueComputed: "CURRENT_TIMESTAMP"

        # Assign ROLE_ADMIN to the admin user
        - sql:
            sql: >
              INSERT INTO user_roles (user_id, role_id)
              SELECT u.id, r.id
              FROM users u
              CROSS JOIN roles r
              WHERE u.username = 'admin' AND r.name = 'ROLE_ADMIN'
              AND NOT EXISTS (
                SELECT 1 FROM user_roles ur
                WHERE ur.user_id = u.id AND ur.role_id = r.id
              )

        # Also give ROLE_USER to admin
        - sql:
            sql: >
              INSERT INTO user_roles (user_id, role_id)
              SELECT u.id, r.id
              FROM users u
              CROSS JOIN roles r
              WHERE u.username = 'admin' AND r.name = 'ROLE_USER'
              AND NOT EXISTS (
                SELECT 1 FROM user_roles ur
                WHERE ur.user_id = u.id AND ur.role_id = r.id
              )
