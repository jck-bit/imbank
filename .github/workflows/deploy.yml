name: Build and Push to ECR

on:
  push:
    branches:
      - master
      - ci-cd-Deployment
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  ECR_REGISTRY: 514867319541.dkr.ecr.us-east-1.amazonaws.com

jobs:
  test-and-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Run tests
        run: mvn test -B

      - name: Build with Maven
        run: mvn clean install -DskipTests -B

  build-and-push:
    needs: test-and-build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Config Server
        run: |
          docker build -f imbank-config-server/Dockerfile -t ${{ env.ECR_REGISTRY }}/imbank-config-server:latest .
          docker push ${{ env.ECR_REGISTRY }}/imbank-config-server:latest

      - name: Build and push Eureka Server
        run: |
          docker build -f imbank-eureka-server/Dockerfile -t ${{ env.ECR_REGISTRY }}/imbank-eureka-server:latest .
          docker push ${{ env.ECR_REGISTRY }}/imbank-eureka-server:latest

      - name: Build and push Auth Service
        run: |
          docker build -f imbank-auth-service/Dockerfile -t ${{ env.ECR_REGISTRY }}/imbank-auth-service:latest .
          docker push ${{ env.ECR_REGISTRY }}/imbank-auth-service:latest

      - name: Build and push Employee Service
        run: |
          docker build -f imbank-employee-service/Dockerfile -t ${{ env.ECR_REGISTRY }}/imbank-employee-service:latest .
          docker push ${{ env.ECR_REGISTRY }}/imbank-employee-service:latest

      - name: Build and push Department Service
        run: |
          docker build -f imbank-department-service/Dockerfile -t ${{ env.ECR_REGISTRY }}/imbank-department-service:latest .
          docker push ${{ env.ECR_REGISTRY }}/imbank-department-service:latest

      - name: Build and push API Gateway
        run: |
          docker build -f imbank-api-gateway/Dockerfile -t ${{ env.ECR_REGISTRY }}/imbank-api-gateway:latest .
          docker push ${{ env.ECR_REGISTRY }}/imbank-api-gateway:latest

      - name: Summary
        run: |
          echo "All images built and pushed to ECR successfully!"
          echo "Images available at:"
          echo "- ${{ env.ECR_REGISTRY }}/imbank-config-server:latest"
          echo "- ${{ env.ECR_REGISTRY }}/imbank-eureka-server:latest"
          echo "- ${{ env.ECR_REGISTRY }}/imbank-auth-service:latest"
          echo "- ${{ env.ECR_REGISTRY }}/imbank-employee-service:latest"
          echo "- ${{ env.ECR_REGISTRY }}/imbank-department-service:latest"
          echo "- ${{ env.ECR_REGISTRY }}/imbank-api-gateway:latest"

  deploy-to-ec2:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # Install Docker if not present
            if ! command -v docker &> /dev/null; then
              sudo yum update -y
              sudo yum install -y docker
              sudo systemctl start docker
              sudo systemctl enable docker
              sudo usermod -aG docker ec2-user
            fi

            # Install Docker Compose if not present
            if ! command -v docker-compose &> /dev/null; then
              sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
              sudo chmod +x /usr/local/bin/docker-compose
            fi

            # Create app directory
            mkdir -p ~/imbank
            cd ~/imbank

            # Login to ECR
            aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin 514867319541.dkr.ecr.us-east-1.amazonaws.com

            # Download docker-compose file
            curl -O https://raw.githubusercontent.com/jck-bit/imbank/ci-cd-Deployment/docker-compose.aws.yml

            # Stop and remove old containers
            docker-compose -f docker-compose.aws.yml down || true

            # Pull latest images
            docker-compose -f docker-compose.aws.yml pull

            # Start services
            docker-compose -f docker-compose.aws.yml up -d

            # Show running containers
            docker ps

            echo "eployment to EC2 completed successfully!"
